apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-proxy-config
  namespace: weather
data:
  envoy.yaml: |
    static_resources:
      listeners:
      - name: redis_listener
        address:
          socket_address: { address: 0.0.0.0, port_value: 6379 }
        filter_chains:
        - filters:
          - name: envoy.filters.network.redis_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.redis_proxy.v3.RedisProxy
              stat_prefix: redis_proxy
              settings:
                op_timeout: 1s
              prefix_routes:
                catch_all_route:
                  cluster: redis_upstream
      clusters:
      - name: redis_upstream
        connect_timeout: 0.5s
        type: STRICT_DNS
        lb_policy: ROUND_ROBIN
        load_assignment:
          cluster_name: redis_upstream
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: redis.weather.svc.cluster.local
                    port_value: 6379
    admin:
      access_log_path: /tmp/admin_access.log
      address:
        socket_address: { address: 0.0.0.0, port_value: 9901 }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-proxy
  namespace: weather
spec:
  replicas: 2
  selector:
    matchLabels:
      app: redis-proxy
  template:
    metadata:
      labels:
        app: redis-proxy
    spec:
      containers:
        - name: envoy
          image: envoyproxy/envoy:v1.30-latest
          args: ["-c", "/etc/envoy/envoy.yaml"]
          ports:
            - containerPort: 6379
            - containerPort: 9901
          volumeMounts:
            - name: cfg
              mountPath: /etc/envoy
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "300m"
              memory: "256Mi"
      volumes:
        - name: cfg
          configMap:
            name: redis-proxy-config
            items:
              - key: envoy.yaml
                path: envoy.yaml
---
apiVersion: v1
kind: Service
metadata:
  name: redis-proxy
  namespace: weather
spec:
  selector:
    app: redis-proxy
  ports:
    - name: redis
      port: 6379
      targetPort: 6379
